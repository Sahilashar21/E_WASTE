{% extends 'base.html' %}

{% block content %}
<div class="mb-8 fade-in-up">
  <h1 class="text-4xl font-bold text-[#005461]">Driver Dashboard</h1>
  <p class="text-gray-500 font-medium mt-1">Your assigned routes and timings</p>
</div>

{% if jobs %}
  <div class="space-y-6 fade-in-up" style="animation-delay: 100ms;">
    {% for job in jobs %}
      {% set c = job.cluster %}
      <div class="glass p-6 rounded-2xl border border-white/50 shadow-sm hover:shadow-md transition-all">
        <div class="flex flex-col md:flex-row justify-between gap-4">
          <div>
            <div class="font-bold text-xl text-[#005461] flex items-center gap-2">
                <span>ğŸš›</span> Route to {{ c.destination or 'Drop-off Hub' }}
            </div>
            <div class="text-sm text-gray-500 mt-1 font-medium">
                <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded">Stops: {{ c.user_count or (c.users|length) }}</span>
                <span class="ml-2">ğŸ“ Distance: {{ c.route_distance_km or 'â€”' }} km</span>
            </div>
            <div class="text-sm text-gray-400 mt-1">ğŸ“… Scheduled: {{ job.scheduled_for or 'TBD' }}</div>
          </div>
          <div class="flex items-center">
            {% if c.status == 'out_for_delivery' %}
              <button onclick="markDelivered('{{ c._id }}')" class="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg hover:scale-105 transition-transform">Mark Delivered</button>
            {% else %}
              <a href="{{ url_for('driver.route_view', cluster_id=c._id) }}" class="bg-gradient-to-r from-[#005461] to-[#00798c] text-white px-6 py-2 rounded-xl font-bold shadow-lg hover:scale-105 transition-transform flex items-center gap-2">
                <span>ğŸš€</span> Start Route
              </a>
            {% endif %}
          </div>
        </div>

        <div class="mt-6 bg-white/40 rounded-xl p-4 border border-white/50">
          <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase tracking-wider">Pickup Stops</h4>
          <ul class="space-y-3">
            {% for p in job.pickups %}
              <li class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border border-gray-100">
                <div>
                  <div class="font-bold text-gray-800">{{ p.user_name }} <span class="text-gray-400 font-normal">â€” {{ p.ewaste_type }}</span></div>
                  <div class="text-xs text-gray-500 mt-0.5">{{ p.address }} â€¢ {{ p.area }}</div>
                </div>
                <div class="text-sm font-mono font-bold text-[#3BC1A8]">{{ p.approx_weight or p.ewaste_weight }} g</div>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="glass p-12 rounded-2xl text-center border-2 border-dashed border-gray-300 fade-in-up">
    <div class="text-6xl mb-4 opacity-20">ğŸ“­</div>
    <h3 class="text-xl font-bold text-gray-600">No Active Routes</h3>
    <p class="text-gray-500 mt-2">You have no assigned pickups at the moment.</p>
  </div>
{% endif %}

<script>
    function markDelivered(clusterId) {
        if (confirm('Mark all pickups as delivered to warehouse?')) {
            fetch(`/warehouse/update-cluster-status/${clusterId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: 'delivered' })
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    alert('Route marked as delivered!');
                    location.reload();
                }
            })
            .catch(e => console.error('Error:', e));
        }
    }
</script>

{% endblock %}
