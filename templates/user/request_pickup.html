{% extends 'base.html' %}
{% block content %}

<style>
    :root {
        --color-primary: #005461;   /* Deep Teal */
        --color-accent: #3BC1A8;    /* Medium Teal */
        --color-bg: #F0FFDF;        /* Light Lime/Green */
        --color-white: #ffffff;
    }

    /* Page Background Override */
    body {
        background-color: var(--color-bg) !important;
        color: var(--color-primary) !important;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    /* Headings */
    h1, h2, h3, label {
        color: var(--color-primary) !important;
    }

    /* Glassmorphism Form Container */
    .pickup-form {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(59, 193, 168, 0.2);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 84, 97, 0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .pickup-form:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 40px rgba(0, 84, 97, 0.12);
    }

    /* Inputs & Textareas */
    input, textarea, select {
        border: 2px solid #e2e8f0;
        border-radius: 10px !important;
        transition: all 0.3s ease;
        background-color: #f8fafc;
    }

    input:focus, textarea:focus {
        border-color: var(--color-accent) !important;
        background-color: #fff;
        box-shadow: 0 0 0 4px rgba(59, 193, 168, 0.15) !important;
        outline: none;
    }

    /* Buttons */
    .btn-submit {
        background: linear-gradient(135deg, var(--color-primary) 0%, #00798c 100%);
        color: white;
        font-weight: 600;
        border-radius: 10px;
        padding: 12px 24px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 84, 97, 0.2);
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(0, 84, 97, 0.3);
        filter: brightness(1.1);
    }

    .btn-secondary {
        background-color: var(--color-accent);
        color: white;
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    
    .btn-secondary:hover {
        background-color: #2ea891;
        transform: translateY(-1px);
    }

    /* Request Cards Animation */
    .request-card {
        background: white;
        border-radius: 12px;
        border-left: 5px solid var(--color-accent);
        box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        opacity: 0;
        animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        margin-bottom: 1rem;
    }

    .request-card:hover {
        transform: scale(1.02);
        box-shadow: 0 12px 24px rgba(0, 84, 97, 0.1);
        z-index: 10;
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Stagger Animations */
    .request-card:nth-child(1) { animation-delay: 0.1s; }
    .request-card:nth-child(2) { animation-delay: 0.2s; }
    .request-card:nth-child(3) { animation-delay: 0.3s; }
    .request-card:nth-child(n+4) { animation-delay: 0.4s; }
</style>

<!-- Leaflet CSS & JS (Free OpenStreetMap Support) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Flash Messages Area -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="mb-4 p-4 rounded 
           {{ 'bg-green-100 text-green-800 border border-green-200' if category == 'success' else 'bg-red-100 text-red-800 border border-red-200' }} shadow-sm">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<h1 class="text-3xl font-bold mb-6 tracking-tight">Request E-Waste Pickup</h1>

<form method="POST" action="/user/request" enctype="multipart/form-data" class="pickup-form p-6 md:p-8 mb-10">

  <!-- Hidden Inputs for GPS Coordinates -->
  <input type="hidden" name="latitude" id="latitude">
  <input type="hidden" name="longitude" id="longitude">

  <!-- Map Section -->
  <div class="mb-6">
    <label class="block text-sm font-bold text-gray-700 mb-2">
      Select Pickup Location (South Mumbai)
    </label>
    
    <!-- Search Bar -->
    <div class="mb-3 relative">
        <input type="text" id="map-search" placeholder="Start typing to search (e.g. Colaba Market)..." 
               class="p-3 w-full border-2 border-gray-200 rounded-lg focus:border-[#3BC1A8] outline-none pr-24"
               oninput="debouncedSearch()">
        <div id="search-status" class="absolute right-3 top-3.5 text-gray-400 text-sm font-medium pointer-events-none"></div>
    </div>

    <div id="map" class="h-64 w-full rounded border border-gray-300 z-0"></div>
    <button type="button" onclick="detectLocation()" class="mt-3 text-sm text-[#005461] hover:text-[#3BC1A8] font-bold flex items-center transition-colors">
      üìç Detect My Current Location
    </button>
  </div>

  <!-- Global Address Fields -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <input name="area" required
      placeholder="Area / Region"
      class="p-3 w-full">
    <textarea name="address" required
      placeholder="Pickup Address"
      class="p-3 w-full"></textarea>
  </div>

  <!-- Dynamic Items Container -->
  <div id="items-container" class="space-y-4 mb-6">
    <!-- Item Row Template (First Item) -->
    <div class="item-row border border-gray-200 p-4 rounded-xl bg-white relative shadow-sm">
      <h3 class="font-bold mb-2 text-gray-700">Item 1</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input name="ewaste_type[]" required placeholder="Type (e.g. Laptop)" class="p-3 w-full">
        <input name="weight[]" type="number" required placeholder="Weight (g)" class="p-3 w-full weight-input" oninput="calculateTotal()">
        <input type="file" name="images[]" accept="image/*" multiple class="p-3 w-full bg-gray-50">
        <input name="item_description[]" placeholder="Specific details (e.g. Broken screen)" class="p-3 w-full">
      </div>
    </div>
  </div>

  <!-- Controls & Totals -->
  <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <button type="button" onclick="addItem()" class="btn-secondary px-6 py-2 font-semibold w-full md:w-auto shadow-sm">
      + Add Another Item
    </button>
    
    <div class="text-xl">
      <span class="text-gray-700 font-bold">Total Weight:</span>
      <span id="display-total" class="text-2xl font-bold text-[#3BC1A8]">0</span> g
    </div>
  </div>

  <!-- General Description -->
  <div class="mb-6">
    <textarea name="description"
      placeholder="General notes about the pickup..."
      class="p-3 w-full"></textarea>
  </div>

  <button class="btn-submit w-full md:w-auto">
    Submit Request
  </button>
</form>

<h2 class="text-2xl font-bold mb-4 mt-8">My Requests</h2>

{% for r in requests %}
<div class="request-card p-5 
    {% if r.status == 'collected' %}border-green-500
    {% elif r.status == 'rejected' %}border-red-500
    {% elif r.status == 'accepted' %}border-blue-500
    {% else %}border-[#3BC1A8]{% endif %}">
    
  <div class="flex justify-between items-start">
    <div>
        <p class="text-lg font-bold text-[#005461]">{{ r.ewaste_type }}</p>
        <p class="text-sm text-gray-500 mt-1">{{ r.created_at.strftime('%Y-%m-%d') }} ‚Ä¢ {{ r.area }}</p>
    </div>
    <div class="text-right">
        <span class="inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide
        {% if r.status == 'collected' %}text-green-600
        {% elif r.status == 'rejected' %}text-red-600
        {% elif r.status == 'accepted' %}text-blue-600
        {% else %}bg-yellow-100 text-yellow-800{% endif %}">
          {{ r.status }}
        </span>
        <p class="mt-2 font-semibold text-gray-600">{{ r.approx_weight }} g</p>
    </div>
  </div>

  {% if r.engineer_price %}
    <div class="mt-3 pt-3 border-t border-gray-100 flex justify-between items-center">
        <span class="text-sm text-gray-500">Estimated Value</span>
        <span class="text-xl font-bold text-[#3BC1A8]">‚Çπ{{ r.engineer_price }}</span>
    </div>
  {% endif %}
</div>
{% else %}
<div class="text-center py-12 bg-white rounded-xl border-2 border-dashed border-gray-300 opacity-75">
    <p class="text-gray-500 text-lg">No requests found yet.</p>
</div>
{% endfor %}

<!-- Map Logic Script -->
<script>
  // 1. Define Mumbai Land Polygon (Expanded to include all suburbs and exclude water)
  var mumbaiPolygon = [
    [18.850, 72.815], // Colaba Tip (Extended South)
    [18.920, 72.780], // Marine Drive / Malabar Hill
    [19.020, 72.800], // Bandra Land's End
    [19.100, 72.815], // Juhu
    [19.120, 72.760], // Madh Island (South)
    [19.180, 72.760], // Madh/Marve (West)
    [19.295, 72.775], // Uttan / Dongri (North West Tip)
    [19.318, 72.840], // Bhayandar West (Vasai Creek Edge)
    [19.315, 72.865], // Bhayandar East (Vasai Creek Edge)
    [19.298, 72.890], // Versova Bridge / Fountain
    [19.292, 72.920], // Chenna Creek / Ghodbunder
    [19.288, 72.965], // Gaimukh / Bhayandarpada (Water Bed Reference)
    [19.275, 72.975], // Ovala / Kasarvadavali
    [19.245, 72.995], // Kolshet Road End (Left of Water)
    [19.220, 73.000], // Balkum / Saket
    [19.195, 72.995], // Thane / Kalwa Bridge
    [19.140, 72.990], // Airoli Bridge (West End)
    [19.030, 72.950], // Mankhurd (Vashi Bridge West)
    [19.000, 72.900], // Trombay / Mahul
    [18.930, 72.850], // Sewri / Eastern Docks
    [18.850, 72.815]  // Close Loop
  ];

  // 2. Initialize Map
  var map = L.map('map', {
      minZoom: 11
  }).setView([19.076, 72.877], 11); // Center on Mumbai

  // 3. Add OpenStreetMap Tile Layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap'
  }).addTo(map);

  // 4. Create "Black and White" Mask (World minus Mumbai)
  var worldCoords = [
    [90, -180],
    [90, 180],
    [-90, 180],
    [-90, -180]
  ];

  // Add a dark overlay to everything OUTSIDE Mumbai
  var maskLayer = L.polygon([worldCoords, mumbaiPolygon], {
    color: 'transparent', 
    fillColor: '#000000', // Black overlay
    fillOpacity: 0.6,     // Slightly reduced opacity so context is visible but dimmed
    interactive: true     // Capture clicks outside
  }).addTo(map);

  // Alert when clicking outside
  maskLayer.on('click', function() {
    alert("Service is only available within Mumbai limits (Land only).");
  });

  // 5. Marker Logic
  var marker;

  async function placeMarker(latlng) {
      // Snap to nearest road using OSRM (Open Source Routing Machine)
      try {
          // OSRM API expects {lon},{lat}
          // Use 'driving' profile for vehicle roads only. radiuses=100 limits search to 100m.
          const osrmUrl = `https://router.project-osrm.org/nearest/v1/driving/${latlng.lng},${latlng.lat}?number=1&radiuses=100`;
          const response = await fetch(osrmUrl);
          const data = await response.json();
          if (data.code === 'Ok' && data.waypoints && data.waypoints.length > 0) {
              const waypoint = data.waypoints[0];
              
              // STRICT CHECK: Distance from click to road (in meters)
              // If > 25m, user likely clicked a park, water, or pedestrian area
              if (waypoint.distance > 25) {
                  alert("Selected location is too far from a vehicle road. Please click closer to a road.");
                  return;
              }

              const [snappedLon, snappedLat] = waypoint.location;
              latlng = L.latLng(snappedLat, snappedLon);
          } else {
              alert("No vehicle road found nearby. Please select a location on a road accessible by vehicle.");
              return;
          }
      } catch (e) {
          console.warn("Road snapping failed.");
          alert("Unable to verify road access. Please try again.");
          return;
      }

      if (marker) map.removeLayer(marker);
      marker = L.marker(latlng, {draggable: true}).addTo(map);

      // Update Hidden Form Inputs
      document.getElementById('latitude').value = latlng.lat;
      document.getElementById('longitude').value = latlng.lng;
      
      // Fetch Address from Nominatim (Free Geocoding)
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&zoom=18&addressdetails=1`)
          .then(response => response.json())
          .then(data => {
              if(data) {
                  // REJECT GREEN ZONES & PEDESTRIAN PATHS
                  const invalidHighwayTypes = ['footway', 'path', 'pedestrian', 'steps', 'cycleway'];
                  if (data.class === 'leisure' || data.class === 'natural' || data.type === 'park' || data.type === 'garden' || 
                     (data.class === 'highway' && invalidHighwayTypes.includes(data.type))) {
                       alert("Selected location appears to be a pedestrian path or green zone. Please select a vehicle-accessible road.");
                       map.removeLayer(marker);
                       marker = null;
                       return;
                  }

                  if (data.address) {
                      // Auto-fill form fields
                      const addr = data.address;
                      
                      // Priority: Suburb (e.g. Andheri) > City District (e.g. Mumbai City) > City
                      // We avoid 'road' or 'neighbourhood' to ensure the region is large enough for engineer logistics.
                      const area = addr.suburb || addr.city_district || addr.town || "Mumbai";
                      const fullAddress = data.display_name;

                      document.querySelector('input[name="area"]').value = area;
                      document.querySelector('textarea[name="address"]').value = fullAddress;
                  }
              }
          })
          .catch(err => console.error("Geocoding error:", err));
      
      // Handle drag end - check if dropped outside
      marker.on('dragend', function(event){
          var newPos = event.target.getLatLng();
          if (isPointInPolygon([newPos.lat, newPos.lng], mumbaiPolygon)) {
              placeMarker(newPos);
          } else {
              alert("Marker dropped outside service area.");
              map.removeLayer(marker);
              marker = null;
              // Clear fields
              document.querySelector('input[name="area"]').value = "";
              document.querySelector('textarea[name="address"]').value = "";
              document.getElementById('latitude').value = "";
              document.getElementById('longitude').value = "";
          }
      });
  }

  // Only allow clicks inside the hole (which fall through to map)
  map.on('click', function(e) {
      // Double check point in polygon just in case
      if (isPointInPolygon([e.latlng.lat, e.latlng.lng], mumbaiPolygon)) {
          placeMarker(e.latlng);
      } else {
          // This usually won't fire because maskLayer catches it, but good for safety
          alert("Service is only available within Mumbai limits.");
      }
  });

  // 6. GPS Detection
  function detectLocation() {
      if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              
              if (isPointInPolygon([lat, lng], mumbaiPolygon)) {
                  map.setView([lat, lng], 15);
                  placeMarker({lat: lat, lng: lng});
              } else {
                  alert("Your current location is outside the Mumbai service area.");
              }
          }, function() {
              alert("Could not get your location. Please allow location access.");
          });
      }
  }

  // 7. Ray-Casting Algorithm for Point-in-Polygon
  function isPointInPolygon(point, vs) {
      var x = point[0], y = point[1];
      var inside = false;
      for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
          var xi = vs[i][0], yi = vs[i][1];
          var xj = vs[j][0], yj = vs[j][1];
          
          var intersect = ((yi > y) != (yj > y))
              && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
          if (intersect) inside = !inside;
      }
      return inside;
  };

  // 8. Dynamic Form Logic
  function calculateTotal() {
      let total = 0;
      document.querySelectorAll('.weight-input').forEach(input => {
          const val = parseFloat(input.value);
          if (!isNaN(val) && val > 0) {
              total += val;
          }
      });
      document.getElementById('display-total').innerText = total;
  }

  function addItem() {
      const container = document.getElementById('items-container');
      const count = container.children.length + 1;
      
      const div = document.createElement('div');
      div.className = 'item-row border border-gray-200 p-4 rounded-xl bg-white relative shadow-sm';
      div.innerHTML = `
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-bold text-gray-700">Item ${count}</h3>
            <button type="button" onclick="this.closest('.item-row').remove(); calculateTotal();" class="text-red-500 text-sm hover:underline">Remove</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input name="ewaste_type[]" required placeholder="Type (e.g. Laptop)" class="p-3 w-full border-2 border-gray-200 rounded-lg">
            <input name="weight[]" type="number" required placeholder="Weight (g)" class="p-3 w-full weight-input border-2 border-gray-200 rounded-lg" oninput="calculateTotal()">
            <input type="file" name="images[]" accept="image/*" multiple class="p-3 w-full bg-gray-50 border-2 border-gray-200 rounded-lg">
            <input name="item_description[]" placeholder="Specific details" class="p-3 w-full border-2 border-gray-200 rounded-lg">
          </div>
      `;
      container.appendChild(div);
  }

  // 9. Search Location Logic
  let debounceTimer;
  
  function debouncedSearch() {
      const query = document.getElementById('map-search').value;
      const status = document.getElementById('search-status');
      
      if (!query) {
          status.innerText = '';
          return;
      }
      
      status.innerText = 'Typing...';
      status.className = 'absolute right-3 top-3.5 text-gray-400 text-sm font-medium pointer-events-none';

      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
          searchLocation();
      }, 1000); // 1 second delay to prevent API spam
  }

  async function searchLocation() {
      const query = document.getElementById('map-search').value;
      const status = document.getElementById('search-status');
      
      if (!query) return;

      status.innerText = 'Searching...';
      status.className = 'absolute right-3 top-3.5 text-blue-500 text-sm font-medium pointer-events-none';

      // Append 'Mumbai' to ensure results are local
      const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ' Mumbai')}&limit=1`;

      try {
          const response = await fetch(searchUrl);
          const data = await response.json();
          
          if (data && data.length > 0) {
              const lat = parseFloat(data[0].lat);
              const lon = parseFloat(data[0].lon);
              
              // Validate bounds (using existing polygon logic)
              if (isPointInPolygon([lat, lon], mumbaiPolygon)) {
                  const latlng = L.latLng(lat, lon);
                  map.setView(latlng, 16);
                  placeMarker(latlng); // This will snap to road and fill address
                  status.innerText = 'Found';
                  status.className = 'absolute right-3 top-3.5 text-green-600 text-sm font-bold pointer-events-none';
              } else {
                  status.innerText = 'Outside Area';
                  status.className = 'absolute right-3 top-3.5 text-red-500 text-sm font-bold pointer-events-none';
              }
          } else {
              status.innerText = 'Not Found';
              status.className = 'absolute right-3 top-3.5 text-gray-500 text-sm pointer-events-none';
          }
      } catch (e) {
          console.error("Search error:", e);
          status.innerText = 'Error';
          status.className = 'absolute right-3 top-3.5 text-red-500 text-sm pointer-events-none';
      }
  }
</script>
{% endblock %}
