<!-- Notifications Panel - Add to base.html before closing body -->
{% if session.get('user_id') %}
<div id="notificationPanel" class="fixed bottom-4 right-4 w-96 max-h-96 bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden flex flex-col z-40">
  <div class="bg-gradient-to-r from-[#005461] to-[#00798c] text-white p-4 flex justify-between items-center">
    <h3 class="font-bold">Notifications</h3>
    <button onclick="closeNotificationPanel()" class="text-2xl">Ã—</button>
  </div>
  
  <div id="notificationsList" class="overflow-y-auto flex-1 p-4 space-y-3">
    <p class="text-gray-500 text-center py-8">Loading notifications...</p>
  </div>
  
  <div class="border-t p-3 text-center text-sm">
    <button onclick="loadNotifications()" class="text-[#005461] font-bold hover:underline">Refresh</button>
  </div>
</div>

<!-- Notification Bell Icon (Top-right corner) -->
<button onclick="toggleNotificationPanel()" class="fixed bottom-8 right-8 bg-[#3BC1A8] text-white rounded-full w-12 h-12 flex items-center justify-center text-xl font-bold shadow-lg hover:bg-[#2ea891] z-50">
  ðŸ””
  <span id="unreadBadge" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center hidden">0</span>
</button>

<script>
let notificationPanelOpen = false;

function toggleNotificationPanel() {
  const panel = document.getElementById('notificationPanel');
  notificationPanelOpen = !notificationPanelOpen;
  panel.style.display = notificationPanelOpen ? 'flex' : 'none';
  if (notificationPanelOpen) loadNotifications();
}

function closeNotificationPanel() {
  document.getElementById('notificationPanel').style.display = 'none';
  notificationPanelOpen = false;
}

async function loadNotifications() {
  try {
    const resp = await fetch('/notifications/my');
    const notifs = await resp.json();
    
    const list = document.getElementById('notificationsList');
    if (notifs.length === 0) {
      list.innerHTML = '<p class="text-gray-500 text-center py-8">No notifications yet</p>';
      return;
    }
    
    list.innerHTML = notifs.map(n => `
      <div class="p-3 bg-white border-l-4 ${n.type.includes('accept') ? 'border-green-500' : n.type.includes('reject') ? 'border-red-500' : 'border-blue-500'} rounded hover:bg-gray-50 cursor-pointer" onclick="markRead('${n._id}')">
        <div class="font-bold text-sm">${n.title}</div>
        <div class="text-xs text-gray-600 mt-1">${n.message}</div>
        <div class="text-xs text-gray-400 mt-2">${new Date(n.created_at).toLocaleString()}</div>
      </div>
    `).join('');
    
    // Update unread count
    const unreadResp = await fetch('/notifications/unread-count');
    const { unread } = await unreadResp.json();
    const badge = document.getElementById('unreadBadge');
    if (unread > 0) {
      badge.textContent = unread;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  } catch (err) {
    console.error('Error loading notifications:', err);
  }
}

async function markRead(notifId) {
  try {
    await fetch(`/notifications/${notifId}/read`, { method: 'POST' });
    loadNotifications();
  } catch (err) {
    console.error('Error marking as read:', err);
  }
}

// Load notifications on page load and poll every 30 seconds
document.addEventListener('DOMContentLoaded', () => {
  loadNotifications();
  setInterval(loadNotifications, 30000);
});
</script>
{% endif %}
